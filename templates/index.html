<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SlideShow</title>
    <style>
        #weather-bar {
            width: 100vw;
            background: black;
            color: #fff;
            font-size: 1.5em;
            text-align: center;
            padding: 18px 0 18px 0;
            margin-bottom: 8px;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 2000;
            box-shadow: 0 2px 8px #000a;
        }
        body {
            padding-top: 60px;
        }
        body { 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            /* margin: 20px;  */
            background-color: black;
        }
        .imgDiv {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        .imgContainer {
            position: absolute;
            transition: opacity 2s ease-in-out;
        }
        .imgContainer.active {
            opacity: 1;
        }
        .imgContainer.inactive {
            opacity: 0;
        }  
        .imgLand {
            max-width: 1400px;
            max-height: 788px;
            border: 8px solid purple;
            border-radius: 12px;
            box-shadow: 0 0 12px purple;
        }
        .imgPort {
            max-width: 563px;
            max-height: 1000px;
            border: 8px solid purple;
            border-radius: 12px;
            box-shadow: 0 0 12px purple;
        }
        .imgSquare {
            max-width: 1400px;
            max-height: 1400px;
            border: 8px solid purple;
            border-radius: 12px;
            box-shadow: 0 0 12px purple;
        }
    </style>
    <script>
        // Weather update logic
        function updateWeather() {
            fetch('/api/weather')
                .then(response => response.json())
                .then(data => {
                    let bar = document.getElementById('weather-bar');
                    if (!bar) return;
                    let icon = data.icon ? `<img src='${data.icon}' style='height:2em;vertical-align:middle;margin-right:8px;'>` : '';
                    let desc = data.description || '';
                    let temp = data.temperature || '';
                    bar.innerHTML = `${icon}${desc} ${temp}`;
                    
                    // Fetch local temps separately
                    fetch('/api/localtemps')
                        .then(response => response.json())
                        .then(localData => {
                            let localTemps = localData.localTemps ? `<span style="color: purple; margin-left: 20px;">${localData.localTemps}</span>` : '';
                            console.log('Local temps:', localTemps);
                            console.log(localData.localTemps.temperature_fahrenheit);
                            bar.innerHTML = `${icon}${desc} ${temp}${localTemps}`;
                        })
                        .catch(() => {
                            // If local temps fail, just show weather without local temps
                        });
                })
                .catch(() => {
                    let bar = document.getElementById('weather-bar');
                    if (bar) bar.innerHTML = 'Weather unavailable';
                });
        }
        let currentImageData = {
            Name: "{{.Name}}",
            Http: "{{.Http}}",
            Orientation: "{{.Orientation}}"
        };

        // Function to try playing audio when page loads
        function playAudio() {
            const audio = document.getElementById('backgroundAudio');
            const message = document.getElementById('audioMessage');
            
            if (audio) {
                audio.play().then(() => {
                    console.log('Audio started successfully');
                    if (message) message.style.display = 'none';
                }).catch(e => {
                    console.log('Autoplay was prevented:', e);
                    if (message) message.style.display = 'block';
                });
            }
        }

        // Function to update the image without page refresh
        function updateImage() {
            fetch('/api/current-image')
                .then(response => response.json())
                .then(data => {
                    if (data && data.Http && data.Http !== currentImageData.Http) {
                        currentImageData = data;
                        const imgDiv = document.querySelector('.imgDiv');
                        let newContainer = document.createElement('div');
                        newContainer.className = 'imgContainer inactive';
                        let ext = (data.Ext || '').replace('.', '').toLowerCase();
                        let activeContainer = imgDiv.querySelector('.imgContainer.active');
                        if (ext === 'mp4') {
                            // Video fade in/out logic
                            newContainer.innerHTML = `<video class="imgLand" src="${data.Http}" controls autoplay style="opacity:0;" playsinline></video>`;
                            imgDiv.appendChild(newContainer);
                            let video = newContainer.querySelector('video');
                            video.onloadeddata = function() {
                                video.style.transition = 'opacity 2s';
                                video.style.opacity = 1;
                                newContainer.classList.remove('inactive');
                                newContainer.classList.add('active');
                            };
                            video.onended = function() {
                                video.style.opacity = 0;
                                newContainer.classList.remove('active');
                                newContainer.classList.add('inactive');
                                setTimeout(() => {
                                    if (newContainer.parentNode) newContainer.parentNode.removeChild(newContainer);
                                }, 2000);
                            };
                            if (activeContainer) {
                                activeContainer.classList.remove('active');
                                activeContainer.classList.add('inactive');
                                setTimeout(() => {
                                    if (activeContainer.parentNode) activeContainer.parentNode.removeChild(activeContainer);
                                }, 2000);
                            }
                        } else {
                            // Image fade in/out logic
                            let imgClass = 'imgSquare';
                            if (data.Orientation === 'landscape') {
                                imgClass = 'imgLand';
                            } else if (data.Orientation === 'portrait') {
                                imgClass = 'imgPort';
                            }
                            newContainer.innerHTML = `<img class="${imgClass}" src="${data.Http}" alt="${data.Name}">`;
                            imgDiv.appendChild(newContainer);
                            const newImg = newContainer.querySelector('img');
                            newImg.onload = function() {
                                newContainer.classList.remove('inactive');
                                newContainer.classList.add('active');
                                if (activeContainer) {
                                    activeContainer.classList.remove('active');
                                    activeContainer.classList.add('inactive');
                                    setTimeout(() => {
                                        if (activeContainer.parentNode) {
                                            activeContainer.parentNode.removeChild(activeContainer);
                                        }
                                    }, 2000);
                                }
                            };
                            newImg.onerror = function() {
                                console.error('Failed to load image:', data.Http);
                                newContainer.classList.remove('inactive');
                                newContainer.classList.add('active');
                                if (activeContainer) {
                                    activeContainer.classList.remove('active');
                                    activeContainer.classList.add('inactive');
                                    setTimeout(() => {
                                        if (activeContainer.parentNode) {
                                            activeContainer.parentNode.removeChild(activeContainer);
                                        }
                                    }, 2000);
                                }
                            };
                        }
                        console.log('Media updated:', data.Name);
                    }
                })
                .catch(error => {
                    console.error('Error fetching image:', error);
                });
        }

        // Start the slideshow update cycle
        function startSlideshow() {
            // Update image every 40 seconds
            setInterval(updateImage, 40000);
        }

        // Try to play audio when page loads
        window.addEventListener('load', function() {
            setTimeout(playAudio, 1000); // Delay to help with loading
            startSlideshow(); // Start the slideshow updates
            updateWeather();
            setInterval(updateWeather, 900000); // Update weather every 15min
        });
        
        // Also try when user interacts with the page
        document.addEventListener('click', function() {
            const audio = document.getElementById('backgroundAudio');
            const message = document.getElementById('audioMessage');
            if (audio && audio.paused) {
                audio.play().then(() => {
                    if (message) message.style.display = 'none';
                }).catch(e => console.log('Play failed:', e));
            }
        });
        
        // Handle audio errors
        window.addEventListener('load', function() {
            const audio = document.getElementById('backgroundAudio');
            if (audio) {
                audio.addEventListener('error', function(e) {
                    console.log('Audio error:', e);
                    const message = document.getElementById('audioMessage');
                    if (message) {
                        message.innerHTML = 'Audio stream unavailable. Click to retry.';
                        message.style.display = 'block';
                    }
                });
            }
        });
    </script>
</head>
<body>
    <div id="weather-bar">Loading weather...</div>
    <!-- Background music from 101.5 HANK FM Seattle & Mad Rock 102.5 -->
    <audio id="backgroundAudio" autoplay loop controls style="position: fixed; bottom: 10px; right: 10px; z-index: 1000; opacity: 0.8;">
        <source src="https://playerservices.streamtheworld.com/api/livestream-redirect/KPLZFMAAC.aac" type="audio/aac">
        <source src="https://playerservices.streamtheworld.com/api/livestream-redirect/KPLZFM.mp3" type="audio/mpeg">
        <source src="https://playerservices.streamtheworld.com/api/livestream-redirect/KMADFMAAC.aac" type="audio/aac">
        <source src="https://playerservices.streamtheworld.com/api/livestream-redirect/KMADFM.mp3" type="audio/mpeg">
        <source src="https://ice42.securenetsystems.net/KPLZ" type="audio/mpeg">
        <source src="https://ice42.securenetsystems.net/KMAD" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>
    
    <!-- Fallback: Show message if audio doesn't work -->
    <div id="audioMessage" style="position: fixed; bottom: 60px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 5px; font-size: 12px; display: none;">
        Click the audio player to start music
    </div>
    
    <div class="imgDiv">
        <div class="imgContainer active">
            {{if eq .Ext "mp4"}}
                {{if eq .Orientation "landscape"}}
                    <video class="imgLand" src="{{.Http}}" controls autoplay playsinline></video>
                {{else if eq .Orientation "portrait"}}
                    <video class="imgPort" src="{{.Http}}" controls autoplay playsinline></video>
                {{else}}
                    <video class="imgSquare" src="{{.Http}}" controls autoplay playsinline></video>
                {{end}}
            {{else if eq .Ext "jpg"}}
                {{if eq .Orientation "landscape"}}
                    <img class="imgLand" src="{{.Http}}" alt="{{.Name}}">
                {{else if eq .Orientation "portrait"}}
                    <img class="imgPort" src="{{.Http}}" alt="{{.Name}}">
                {{else}}
                    <img class="imgSquare" src="{{.Http}}" alt="{{.Name}}">
                {{end}}
            {{end}}
        </div>
    </div>
</body>
</html>
